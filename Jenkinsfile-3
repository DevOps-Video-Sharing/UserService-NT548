pipeline {
    agent any

    stages {
	stage('Prepare')
           steps {
                 //Làm cho script mvnw có thể thực thi
                sh 'chmod +x mvnw'

                 //Xây dựng dự án bằng Maven
                sh './mvnw clean package'
            }
        }

        stage('Build') {
            steps {
                // Xây dựng Docker image
                sh 'docker build -t datuits/userservice-lab:latest .'
            }
        }

        stage('Security Scan') {
            steps {
                script {
                    // Run Trivy scan and redirect the output to a file in the workspace
                    sh 'trivy -q -f json datuits/userservice-lab:latest > $WORKSPACE/trivy-report.json'
                    
                    // Optionally read the JSON report and process it
                    def trivyReport = readFile('$WORKSPACE/trivy-report.json')
                    writeFile file: 'trivyScan.md', text: trivyReport
                }
            }
        }
    }
}

